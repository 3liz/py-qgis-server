stages:
- test
- build
- docker
- deploy
- release

#-----------------
# Tests
#-----------------

.run-tests:
  stage: test
  script:
    - make manifest docker-test FLAVOR=$QGIS_FLAVOR
  tags:
    - infrav3
  only:
    refs:
      - tags
      - master

tests:ltr:
  extends: .run-tests 
  variables:
    QGIS_FLAVOR: ltr

tests:release:
  extends: .run-tests 
  variables:
    QGIS_FLAVOR: release

#---------------
# Build
#---------------

build:
  stage: build
  script:
    - make dist deliver
    - make -C .lizcloud -f factory.mk package
  environment:
    name: snap
  tags:
    - infrav3
  only:
    refs:
      - tags
      - master
  except:
      - schedules
      - triggers
  artifacts:
    paths:
      - ".lizcloud/factory.manifest"

release:
  stage: release
  script:
    - $FACTORY_SCRIPTS/release-package py-qgis-server
  environment:
    name: production
  dependencies:
    - build
  only:
    refs:
      - tags
  tags:
    - infrav3
  variables:
    FACTORY_MANIFEST: ".lizcloud/factory.manifest"


# Docker build
include: '/docker/.gitlab-ci.yml'

